<!-- 주문 상세 정보 모달 -->
<div class="modal" id="orderDetailModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">주문 상세 정보</h2>
        <button type="button" class="close-btn" id="closeDetailModalBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="orderDetailContent">
        <!-- 상세 정보 내용은 JavaScript로 동적 생성 -->
        <div class="loading-spinner" id="modalLoadingSpinner">
          <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-text">주문 정보 로드 중...</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-left">
          {% if user.user_role == 'ADMIN' %}
          <button type="button" class="btn delete-btn" id="deleteOrderBtn">
            <i class="fas fa-trash"></i> 삭제
          </button>
          {% endif %}
        </div>
        <div class="modal-footer-right">
          <button type="button" class="btn secondary-btn" id="closeModalBtn">닫기</button>
          <button type="button" class="btn primary-btn" id="editOrderBtn">수정하기</button>
          <button type="button" class="btn primary-btn" id="saveOrderBtn" style="display: none">저장하기</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 템플릿 (DOM에 렌더링되지 않고 JS에서 참조) -->
<template id="orderDetailTemplate">
  <form id="orderDetailForm" class="order-form">
    <div class="detail-header">
      <h3 class="detail-title">주문 #<span class="order-no-placeholder"></span></h3>
      <span class="status-badge status-placeholder"></span>
    </div>
    
    <div class="lock-info-container"></div>
    
    <div class="form-section">
      <h4 class="section-title">기본 정보</h4>
      <div class="form-row">
        <div class="form-group">
          <label for="detailOrderNo">주문번호 *</label>
          <input type="text" id="detailOrderNo" name="orderNo" required readonly>
        </div>
        <div class="form-group">
          <label for="detailType">유형 *</label>
          <select id="detailType" name="type" required disabled>
            <option value="DELIVERY">배송</option>
            <option value="RETURN">회수</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="detailDepartment">부서 *</label>
          <select id="detailDepartment" name="department" required disabled>
            <option value="CS">CS</option>
            <option value="HES">HES</option>
            <option value="LENOVO">LENOVO</option>
          </select>
        </div>
        <div class="form-group">
          <label for="detailWarehouse">창고 *</label>
          <select id="detailWarehouse" name="warehouse" required disabled>
            <option value="SEOUL">서울</option>
            <option value="BUSAN">부산</option>
            <option value="GWANGJU">광주</option>
            <option value="DAEJEON">대전</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="detailSLA">SLA *</label>
          <input type="text" id="detailSLA" name="sla" required readonly>
        </div>
        <div class="form-group">
          <label for="detailETA">ETA *</label>
          <input type="datetime-local" id="detailETA" name="eta" required readonly>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h4 class="section-title">배송 정보</h4>
      <div class="form-row">
        <div class="form-group">
          <label for="detailPostalCode">우편번호 *</label>
          <input type="text" id="detailPostalCode" name="postalCode" maxlength="5" pattern="[0-9]{5}" required readonly>
        </div>
        <div class="form-group">
          <label for="detailRegion">지역</label>
          <input type="text" id="detailRegion" name="region" readonly>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group full-width">
          <label for="detailAddress">주소 *</label>
          <input type="text" id="detailAddress" name="address" required readonly>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="detailCustomer">고객명 *</label>
          <input type="text" id="detailCustomer" name="customer" required readonly>
        </div>
        <div class="form-group">
          <label for="detailContact">연락처</label>
          <input type="text" id="detailContact" name="contact" pattern="010-[0-9]{4}-[0-9]{4}" readonly>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h4 class="section-title">상태 정보</h4>
      <div class="form-row">
        <div class="form-group">
          <label for="detailStatus">현재 상태 *</label>
          <select id="detailStatus" name="status" required disabled>
            <option value="WAITING">대기</option>
            <option value="IN_PROGRESS">진행 중</option>
            <option value="COMPLETE">완료</option>
            <option value="ISSUE">이슈</option>
            <option value="CANCEL">취소</option>
          </select>
        </div>
        <div class="form-group">
          <label for="detailCreatedTime">접수 시간</label>
          <input type="text" id="detailCreatedTime" readonly>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="detailDepartTime">출발 시간</label>
          <input type="text" id="detailDepartTime" readonly>
        </div>
        <div class="form-group">
          <label for="detailCompleteTime">완료 시간</label>
          <input type="text" id="detailCompleteTime" readonly>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h4 class="section-title">배차 정보</h4>
      <div class="form-row">
        <div class="form-group">
          <label for="detailDriverName">기사명</label>
          <input type="text" id="detailDriverName" name="driverName" readonly>
        </div>
        <div class="form-group">
          <label for="detailDriverContact">기사 연락처</label>
          <input type="text" id="detailDriverContact" name="driverContact" readonly>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h4 class="section-title">기타 정보</h4>
      <div class="form-row">
        <div class="form-group full-width">
          <label for="detailRemark">비고</label>
          <textarea id="detailRemark" name="remark" rows="3" readonly></textarea>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="detailUpdatedBy">마지막 수정자</label>
          <input type="text" id="detailUpdatedBy" readonly>
        </div>
        <div class="form-group">
          <label for="detailUpdatedAt">수정 시간</label>
          <input type="text" id="detailUpdatedAt" readonly>
        </div>
      </div>
    </div>
  </form>
</template>

<script>
(function() {
  // 캐시 설정 (주문 상세 정보 캐싱)
  const orderCache = new Map();
  const CACHE_TIMEOUT = 60000; // 1분 캐시
  
  // 편집 중인 필드 추적
  const editingFields = new Set();
  
  // 주문 상세 정보 관련 변수
  
  /**
   * 초기화 함수
   */
  function init() {
    console.log('[OrderDetailModal] 초기화 시작');
    
    // 닫기 버튼 이벤트
    const closeModalBtn = document.getElementById('closeModalBtn');
    const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
    
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    if (closeDetailModalBtn) {
      closeDetailModalBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    // 수정 버튼 이벤트
    const editOrderBtn = document.getElementById('editOrderBtn');
    if (editOrderBtn) {
      editOrderBtn.addEventListener('click', function() {
        toggleOrderEditMode(true);
      });
    }
    
    // 저장 버튼 이벤트
    const saveOrderBtn = document.getElementById('saveOrderBtn');
    if (saveOrderBtn) {
      saveOrderBtn.addEventListener('click', function() {
        saveOrderChanges();
      });
    }
    
    // 삭제 버튼 이벤트
    const deleteOrderBtn = document.getElementById('deleteOrderBtn');
    if (deleteOrderBtn) {
      deleteOrderBtn.addEventListener('click', function() {
        const orderId = getCurrentOrderId();
        if (orderId) {
          showModal('deleteConfirmModal');
        }
      });
    }
    
    // 인라인 편집 버튼 제거됨
    
    // 행 클릭 이벤트
    document.addEventListener('click', function(event) {
      const viewBtn = event.target.closest('.view-btn');
      if (viewBtn) {
        event.preventDefault();
        const orderId = viewBtn.dataset.id;
        if (orderId) {
          showOrderDetail(orderId);
        }
      }
    });
    
    console.log('[OrderDetailModal] 초기화 완료');
  }
  
  /**
   * 모달 표시
   */
  function showModal() {
    const modal = document.getElementById('orderDetailModal');
    if (!modal) return;
    
    // 모달 표시
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // 애니메이션 효과
    setTimeout(function() {
      modal.classList.add('show');
    }, 10);
  }
  
  /**
   * 모달 숨김
   */
  function hideModal() {
    const modal = document.getElementById('orderDetailModal');
    if (!modal) return;
    
    // 애니메이션 효과
    modal.classList.remove('show');
    
    // 약간의 지연 후 완전히 숨김
    setTimeout(function() {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }, 300);
  }
  
  /**
   * 주문 상세 정보 표시
   * @param {string} orderId - 주문 ID
   */
  /**
   * 주문 상세 정보를 표시합니다.
   * @param {string} orderId - 주문 ID
   * @param {Object} options - 추가 옵션
   * @param {boolean} options.forceReload - 캐시를 무시하고 새로 로드할지 여부
   * @param {boolean} options.showNotifications - 알림 표시 여부
   */
  async function showOrderDetail(orderId, options = {}) {
    // 기본 옵션
    const { 
      forceReload = false,
      showNotifications = true 
    } = options;
    
    if (!orderId) {
      console.error('[OrderDetailModal] 주문 ID가 없습니다.');
      return;
    }
    
    console.log(`[OrderDetailModal] 주문 상세 정보 표시: ID=${orderId}, 캐시무시=${forceReload}`);
    
    // 현재 주문 ID 저장 (세션 스토리지 사용 - 탭 닫으면 초기화)
    sessionStorage.setItem('currentOrderId', orderId);
    // 사용자 ID 및 타임스탬프도 저장하여 권한 및 시간 추적
    const userId = document.body.dataset.userId || 'anonymous';
    sessionStorage.setItem('orderDetailLastUser', userId);
    sessionStorage.setItem('orderDetailLastAccess', new Date().toISOString());
    
    const orderDetailContent = document.getElementById('orderDetailContent');
    const modalLoadingSpinner = document.getElementById('modalLoadingSpinner');
    
    if (!orderDetailContent) {
      console.error('[OrderDetailModal] 모달 컨텐츠 요소를 찾을 수 없습니다.');
      if (showNotifications) {
        showAlert('내부 오류: 모달 요소를 찾을 수 없습니다.', 'error');
      }
      return;
    }
    
    // 모달 표시
    showModal();
    
    // 초기 상태로 모달 설정
    orderDetailContent.innerHTML = '';
    
    // 로딩 표시
    if (modalLoadingSpinner) {
      modalLoadingSpinner.style.display = 'flex';
    }
    
    // 로딩 시작 시간 기록 (성능 측정용)
    const loadStartTime = performance.now();
    
    try {
      // 캐시 확인
      let orderData;
      const userId = document.body.dataset.userId || 'unknown';
      // 사용자 ID를 캐시 키에 포함시켜 다른 사용자 세션과 구분
      const cacheKey = `order_${orderId}_${userId}`;
      const cachedData = orderCache.get(cacheKey);
      
      const now = Date.now();
      const useCache = !forceReload && 
                     cachedData && 
                     (now - cachedData.timestamp < CACHE_TIMEOUT);
      
      if (useCache) {
        // 캐시된 데이터 사용
        console.log('[OrderDetailModal] 캐시에서 주문 데이터 로드 (시간:', now - cachedData.timestamp, 'ms 경과)');
        orderData = cachedData.data;
        
        // 캐시 히트 증가 (캐시 성능 측정용)
        cachedData.hits = (cachedData.hits || 0) + 1;
        orderCache.set(cacheKey, cachedData);
      } else {
        // API에서 데이터 로드
        console.log(`[OrderDetailModal] API에서 주문 데이터 로드 ${forceReload ? '(강제 로드)' : ''}`);
        
        try {
          // 첫 번째 시도: 표준화된 API 호출
          const response = await fetchOrderDetail(orderId);
          
          if (!response.success) {
            throw new Error(response.message || '주문 정보를 불러오는 중 오류가 발생했습니다.');
          }
          
          orderData = response.data;
          
        } catch (apiError) {
          console.warn('[OrderDetailModal] 기본 API 호출 실패, 대체 방법 시도:', apiError);
          
          try {
            // 두 번째 시도: 직접 API 호출 (fallback)
            const directResponse = await fetch(`/dashboard/orders/${orderId}`, {
              headers: { 'Accept': 'application/json' },
              credentials: 'same-origin'
            });
            
            if (!directResponse.ok) {
              // HTTP 오류 처리
              if (directResponse.status === 404) {
                throw new Error(`주문을 찾을 수 없습니다. (ID: ${orderId})`);
              } else if (directResponse.status === 401 || directResponse.status === 403) {
                throw new Error('주문 정보에 접근할 권한이 없습니다.');
              } else {
                throw new Error(`API 호출 실패: ${directResponse.status} - ${directResponse.statusText}`);
              }
            }
            
            // 성공적인 응답 처리
            const rawData = await directResponse.json();
            console.log('[OrderDetailModal] 직접 API 호출로 데이터 로드 성공');
            
            // 필수 필드 검증
            if (!rawData || !rawData.dashboardId) {
              throw new Error('서버 응답에 필요한 데이터가 포함되어 있지 않습니다.');
            }
            
            orderData = rawData;
            
          } catch (fallbackError) {
            // 두 번째 시도도 실패
            console.error('[OrderDetailModal] 모든 API 호출 방법 실패:', fallbackError);
            throw fallbackError; // 에러를 상위로 전파
          }
        }
        
        // 캐시에 저장 (새로 로드된 데이터)
        if (orderData) {
          orderCache.set(cacheKey, {
            data: orderData,
            timestamp: now,
            hits: 0
          });
          console.log('[OrderDetailModal] 데이터를 캐시에 저장함 (키:', cacheKey, ')');
        }
      }
      
      // 로딩 완료 시간 측정 (성능 모니터링)
      const loadEndTime = performance.now();
      console.log(`[OrderDetailModal] 데이터 로드 시간: ${Math.round(loadEndTime - loadStartTime)}ms`);
      
      // 로딩 완료 UI 처리
      if (modalLoadingSpinner) {
        modalLoadingSpinner.style.display = 'none';
      }
      
      // 데이터 유효성 검증 - 필수 필드 존재 여부 확인
      if (!orderData || typeof orderData !== 'object') {
        throw new Error('주문 정보가 유효하지 않습니다.');
      }
      
      const requiredFields = ['dashboardId', 'orderNo', 'status'];
      const missingFields = requiredFields.filter(field => orderData[field] === undefined);
      
      if (missingFields.length > 0) {
        throw new Error(`필수 데이터 누락: ${missingFields.join(', ')}`);
      }
      
      // 필요한 경우 데이터 추가 가공
      processOrderData(orderData);
      
      // 모달 내용 업데이트
      renderOrderDetail(orderDetailContent, orderData);
      
      // 수정 버튼 상태 업데이트
      updateEditButtonState(orderData);
      
      // 주문 정보 표시 성공 이벤트 발생
      const successEvent = new CustomEvent('orderDetailLoaded', { 
        detail: { orderId, timestamp: new Date().toISOString() } 
      });
      document.dispatchEvent(successEvent);
      
    } catch (error) {
      // 에러 발생 시 처리
      console.error('[OrderDetailModal] 상세 정보 로드 중 오류:', error);
      
      // 로딩 완료 (오류 발생)
      if (modalLoadingSpinner) {
        modalLoadingSpinner.style.display = 'none';
      }
      
      // 에러 UI 표시
      orderDetailContent.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-circle"></i>
          <h3>정보 로드 실패</h3>
          <p>${error.message || '주문 정보를 불러오는 중 오류가 발생했습니다.'}</p>
          <p class="error-details">오류 코드: ERR-${Math.floor(Math.random() * 10000)}</p>
          <div class="error-actions">
            <button class="btn retry-btn" id="retryLoadBtn">
              <i class="fas fa-sync"></i> 다시 시도
            </button>
            <button class="btn secondary-btn" id="errorCloseBtn">
              <i class="fas fa-times"></i> 닫기
            </button>
          </div>
        </div>
      `;
      
      // 재시도 버튼
      const retryBtn = document.getElementById('retryLoadBtn');
      if (retryBtn) {
        retryBtn.addEventListener('click', function() {
          // 캐시 삭제 후 다시 시도 (강제 새로고침)
          orderCache.delete(`order_${orderId}_${userId}`);
          showOrderDetail(orderId, { forceReload: true });
        });
      }
      
      // 닫기 버튼
      const errorCloseBtn = document.getElementById('errorCloseBtn');
      if (errorCloseBtn) {
        errorCloseBtn.addEventListener('click', hideModal);
      }
      
      // 오류 알림 표시
      if (showNotifications) {
        showAlert('주문 정보를 불러오는 중 오류가 발생했습니다: ' + error.message, 'error');
      }
      
      // 오류 이벤트 발생
      const errorEvent = new CustomEvent('orderDetailError', { 
        detail: { 
          orderId, 
          error: error.message, 
          timestamp: new Date().toISOString() 
        } 
      });
      document.dispatchEvent(errorEvent);
    }
  }
  
  /**
   * 주문 데이터 전처리 및 보정
   * @param {Object} data - 가공할 주문 데이터
   */
  function processOrderData(data) {
    // 필드 타입 확인 및 기본값 설정
    if (!data.status) data.status = 'WAITING';
    if (!data.statusLabel) {
      // 상태 라벨 자동 생성
      const statusMap = {
        'WAITING': '대기',
        'IN_PROGRESS': '진행',
        'COMPLETE': '완료',
        'ISSUE': '이슈',
        'CANCEL': '취소'
      };
      data.statusLabel = statusMap[data.status] || data.status;
    }
    
    // 날짜 형식 변환 (있는 경우)
    if (data.eta && data.eta.includes(' ') && !data.eta.includes('T')) {
      // 'YYYY-MM-DD HH:MM:SS' 형식을 'YYYY-MM-DDTHH:MM:SS' 형식으로 변환 (datetime-local 입력용)
      data.eta = data.eta.replace(' ', 'T');
    }
    
    // 빈 값 처리
    if (!data.address) data.address = '';
    if (!data.customer) data.customer = '';
    if (!data.remark) data.remark = '';
    
    // 업데이트 정보 처리
    if (!data.updatedBy) data.updatedBy = '-';
    if (!data.updateAt) data.updateAt = '-';
    
    return data;
  }
  
  /**
   * 주문 수정 버튼 상태 업데이트
   * @param {Object} orderData - 주문 데이터
   */
  function updateEditButtonState(orderData) {
    const editBtn = document.getElementById('editOrderBtn');
    const deleteBtn = document.getElementById('deleteOrderBtn');
    
    if (editBtn) {
      // 관리자 또는 락이 없는 경우 수정 가능
      const userRole = document.body.dataset.userRole || 'USER';
      const isAdmin = userRole === 'ADMIN';
      const isLocked = orderData.isLocked === true;
      const canEdit = isAdmin || !isLocked;
      
      // 버튼 상태 업데이트
      editBtn.disabled = !canEdit;
      editBtn.title = canEdit ? 
        '주문 정보를 수정합니다' :
        '다른 사용자가 편집 중이거나 권한이 없습니다';
      
      // 시각적 스타일 적용
      if (canEdit) {
        editBtn.classList.remove('disabled-btn');
      } else {
        editBtn.classList.add('disabled-btn');
      }
    }
    
    // 삭제 버튼은 관리자만 사용 가능
    if (deleteBtn) {
      const userRole = document.body.dataset.userRole || 'USER';
      const isAdmin = userRole === 'ADMIN';
      deleteBtn.disabled = !isAdmin;
      deleteBtn.style.display = isAdmin ? 'inline-block' : 'none';
    }
  }
  
  // 인라인 편집 기능 제거
  
  /**
   * 필드 편집 모드 전환
   * @param {string} fieldId - 필드 ID
   * @param {boolean} editable - 편집 가능 여부
   */
  function toggleFieldEdit(fieldId, editable) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    if (field.tagName === 'INPUT') {
      field.readOnly = !editable;
    } else if (field.tagName === 'SELECT') {
      field.disabled = !editable;
    } else if (field.tagName === 'TEXTAREA') {
      field.readOnly = !editable;
    }
    
    if (editable) {
      field.focus();
      field.classList.add('editing');
    } else {
      field.classList.remove('editing');
    }
  }
  
  /**
   * 주문 정보 수정 모드 전환
   * @param {boolean} isEdit - 수정 모드 여부
   */
  function toggleOrderEditMode(isEdit) {
    const saveBtn = document.getElementById('saveOrderBtn');
    const editBtn = document.getElementById('editOrderBtn');
    
    if (saveBtn) saveBtn.style.display = isEdit ? 'block' : 'none';
    if (editBtn) editBtn.style.display = isEdit ? 'none' : 'block';
    
    // 입력 필드 상태 업데이트
    const form = document.getElementById('orderDetailForm');
    if (form) {
      // remark 필드만 편집 가능하도록 설정
      const remark = document.getElementById('detailRemark');
      if (remark) {
        remark.readOnly = !isEdit;
        if (isEdit) {
          remark.classList.add('editing');
          remark.focus();
        } else {
          remark.classList.remove('editing');
        }
      }
      
      // 다른 모든 필드는 readonly 유지
      const inputs = form.querySelectorAll('input');
      const selects = form.querySelectorAll('select');
      
      inputs.forEach(input => {
        input.readOnly = true;
      });
      
      selects.forEach(select => {
        select.disabled = true;
      });
    }
  }
  
  /**
   * 주문 상세 정보 API 호출
   * @param {string} orderId - 주문 ID
   * @returns {Promise<Object>} - 표준화된 응답 객체
   */
  async function fetchOrderDetail(orderId) {
    try {
      // API 호출 전 로깅
      console.log(`[OrderDetailModal] API 호출 시작: /dashboard/orders/${orderId}`);
      const startTime = performance.now();
      
      // API 호출 실행
      const response = await fetch(`/dashboard/orders/${orderId}`, {
        headers: {
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin' // 세션 쿠키 포함
      });
      
      // 응답 시간 측정
      const endTime = performance.now();
      console.log(`[OrderDetailModal] API 호출 완료: ${Math.round(endTime - startTime)}ms`);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP 오류 ${response.status}: ${errorText}`);
      }
      
      const data = await response.json();
      
      // 데이터 유효성 기본 검사
      if (!data || typeof data !== 'object') {
        throw new Error('API 응답이 유효한 JSON 객체가 아닙니다');
      }
      
      // 필수 필드 확인
      const requiredFields = ['dashboardId', 'orderNo', 'status'];
      const missingFields = requiredFields.filter(field => data[field] === undefined);
      
      if (missingFields.length > 0) {
        console.warn(`[OrderDetailModal] 응답에 필수 필드가 누락됨: ${missingFields.join(', ')}`);
      }
      
      // 응답 데이터 로깅 (민감 정보 제외)
      console.log('[OrderDetailModal] 응답 데이터:', {
        dashboardId: data.dashboardId,
        orderNo: data.orderNo,
        status: data.status,
        type: data.type,
        // 전체 데이터는 로깅하지 않음
      });
      
      // 백엔드 응답을 표준 형식으로 변환
      return { 
        success: true, 
        data: data,
        message: '주문 정보 로드 성공',
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      console.error('[OrderDetailModal] API 오류:', error);
      return { 
        success: false, 
        message: '서버 통신 중 오류가 발생했습니다.',
        error: error.toString(),
        timestamp: new Date().toISOString()
      };
    }
  }
  
  /**
   * 주문 상세 정보 렌더링
   * @param {HTMLElement} container - 컨테이너 요소
   * @param {Object} orderData - 주문 데이터
   */
  function renderOrderDetail(container, orderData) {
    if (!container) {
      console.error('[OrderDetailModal] 상세 정보 렌더링 실패: 컨테이너 누락');
      return;
    }
    
    if (!orderData || typeof orderData !== 'object') {
      console.error('[OrderDetailModal] 상세 정보 렌더링 실패: 데이터 누락 또는 유효하지 않음', orderData);
      container.innerHTML = '<div class="error-message">상세 정보를 표시할 수 없습니다: 유효하지 않은 데이터</div>';
      return;
    }
    
    console.log('[OrderDetailModal] 상세 정보 렌더링 시작', { 
      orderId: orderData.dashboardId,
      orderNo: orderData.orderNo,
      fields: Object.keys(orderData)
    });
    
    // 폼 생성
    const html = `
      <form id="orderDetailForm" class="order-form">
        <div class="detail-header">
          <h3 class="detail-title">주문 #${orderData.orderNo || '-'}</h3>
          <span class="status-badge status-${orderData.status || 'WAITING'}">
            ${orderData.statusLabel || '대기'}
          </span>
        </div>
        
        <!-- 락 정보 (있는 경우) -->
        ${orderData.isLocked && orderData.updatedBy !== document.body.dataset.userId ? 
          `<div class="lock-info">
            <i class="fas fa-lock"></i>
            <span>현재 ${orderData.updatedBy || '다른 사용자'}가 이 주문을 편집 중입니다.</span>
          </div>` : ''
        }
        
        <div class="form-section">
          <h4 class="section-title">기본 정보</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="detailOrderNo">주문번호 *</label>
              <input type="text" id="detailOrderNo" name="orderNo" value="${orderData.orderNo || ''}" required readonly>
            </div>
            <div class="form-group">
              <label for="detailType">유형 *</label>
              <select id="detailType" name="type" required disabled>
                <option value="DELIVERY" ${orderData.type === 'DELIVERY' ? 'selected' : ''}>배송</option>
                <option value="RETURN" ${orderData.type === 'RETURN' ? 'selected' : ''}>회수</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="detailDepartment">부서 *</label>
              <select id="detailDepartment" name="department" required disabled>
                <option value="CS" ${orderData.department === 'CS' ? 'selected' : ''}>CS</option>
                <option value="HES" ${orderData.department === 'HES' ? 'selected' : ''}>HES</option>
                <option value="LENOVO" ${orderData.department === 'LENOVO' ? 'selected' : ''}>LENOVO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="detailWarehouse">창고 *</label>
              <select id="detailWarehouse" name="warehouse" required disabled>
                <option value="SEOUL" ${orderData.warehouse === 'SEOUL' ? 'selected' : ''}>서울</option>
                <option value="BUSAN" ${orderData.warehouse === 'BUSAN' ? 'selected' : ''}>부산</option>
                <option value="GWANGJU" ${orderData.warehouse === 'GWANGJU' ? 'selected' : ''}>광주</option>
                <option value="DAEJEON" ${orderData.warehouse === 'DAEJEON' ? 'selected' : ''}>대전</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="detailSLA">SLA *</label>
              <input type="text" id="detailSLA" name="sla" value="${orderData.sla || ''}" required readonly>
            </div>
            <div class="form-group">
              <label for="detailETA">ETA *</label>
              <input type="datetime-local" id="detailETA" name="eta" 
                value="${orderData.eta ? orderData.eta.replace(' ', 'T') : ''}" required readonly>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">배송 정보</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="detailPostalCode">우편번호 *</label>
              <input type="text" id="detailPostalCode" name="postalCode" 
                value="${orderData.postalCode || ''}" maxlength="5" pattern="[0-9]{5}" required readonly>
            </div>
            <div class="form-group">
              <label for="detailRegion">지역</label>
              <input type="text" id="detailRegion" name="region" value="${orderData.region || ''}" readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group full-width">
              <label for="detailAddress">주소 *</label>
              <input type="text" id="detailAddress" name="address" value="${orderData.address || ''}" required readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="detailCustomer">고객명 *</label>
              <input type="text" id="detailCustomer" name="customer" value="${orderData.customer || ''}" required readonly>
            </div>
            <div class="form-group">
              <label for="detailContact">연락처</label>
              <input type="text" id="detailContact" name="contact" value="${orderData.contact || ''}" readonly
                pattern="010-[0-9]{4}-[0-9]{4}">
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">상태 정보</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="detailStatus">현재 상태 *</label>
              <select id="detailStatus" name="status" required disabled>
                <option value="WAITING" ${orderData.status === 'WAITING' ? 'selected' : ''}>대기</option>
                <option value="IN_PROGRESS" ${orderData.status === 'IN_PROGRESS' ? 'selected' : ''}>진행 중</option>
                <option value="COMPLETE" ${orderData.status === 'COMPLETE' ? 'selected' : ''}>완료</option>
                <option value="ISSUE" ${orderData.status === 'ISSUE' ? 'selected' : ''}>이슈</option>
                <option value="CANCEL" ${orderData.status === 'CANCEL' ? 'selected' : ''}>취소</option>
              </select>
            </div>
            <div class="form-group">
              <label for="detailCreatedTime">접수 시간</label>
              <input type="text" id="detailCreatedTime" value="${orderData.createTime || ''}" readonly>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="detailDepartTime">출발 시간</label>
              <input type="text" id="detailDepartTime" value="${orderData.departTime || '-'}" readonly>
            </div>
            <div class="form-group">
              <label for="detailCompleteTime">완료 시간</label>
              <input type="text" id="detailCompleteTime" value="${orderData.completeTime || '-'}" readonly>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">배차 정보</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="detailDriverName">기사명</label>
              <input type="text" id="detailDriverName" name="driverName" value="${orderData.driverName || ''}" readonly>
            </div>
            <div class="form-group">
              <label for="detailDriverContact">기사 연락처</label>
              <input type="text" id="detailDriverContact" name="driverContact" value="${orderData.driverContact || ''}" readonly>
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h4 class="section-title">기타 정보</h4>
          <div class="form-row">
            <div class="form-group full-width">
              <label for="detailRemark">비고</label>
              <textarea id="detailRemark" name="remark" rows="3" readonly>${orderData.remark || ''}</textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="detailUpdatedBy">마지막 수정자</label>
              <input type="text" id="detailUpdatedBy" value="${orderData.updatedBy || '-'}" readonly>
            </div>
            <div class="form-group">
              <label for="detailUpdatedAt">수정 시간</label>
              <input type="text" id="detailUpdatedAt" value="${orderData.updateAt || '-'}" readonly>
            </div>
          </div>
        </div>
      </form>
    `;
    
    container.innerHTML = html;
  }
  
  /**
   * 주문 변경사항 저장
   */
  async function saveOrderChanges() {
    const form = document.getElementById('orderDetailForm');
    const orderId = getCurrentOrderId();
    
    if (!form || !orderId) {
      console.error('[OrderDetailModal] 주문 저장 실패: 폼 또는 주문 ID 누락');
      return;
    }
    
    // 폼 유효성 검사
    if (!validateForm(form)) {
      console.warn('[OrderDetailModal] 유효성 검사 실패');
      showAlert('필수 항목을 모두 입력해주세요.', 'warning');
      return;
    }
    
    // 락 상태 확인 (락이 없거나 만료되었을 수 있음)
    try {
      console.log(`[OrderDetailModal] 락 상태 확인 시작: 주문 ID=${orderId}`);
      
      // 락 상태 API 호출
      const lockStatus = await fetch(`/dashboard/lock/${orderId}`).then(r => r.json());
      
      if (!lockStatus.editable) {
        console.warn('[OrderDetailModal] 편집 권한 없음', lockStatus);
        showAlert(lockStatus.message || '현재 이 주문을 편집할 권한이 없습니다.', 'error');
        toggleOrderEditMode(false);
        return;
      }
      
      console.log('[OrderDetailModal] 락 확인 완료: 편집 가능');
    } catch (error) {
      console.error('[OrderDetailModal] 락 상태 확인 중 오류', error);
    }
    
    // 폼 데이터 수집
    const formData = getFormData(form);
    
    try {
      console.log('[OrderDetailModal] 주문 업데이트 시작', { orderId, formData });
      toggleLoading(true);
      
      // API 호출
      const response = await callApi('PUT', `/dashboard/orders/${orderId}`, formData);
      
      if (response.success) {
        console.log('[OrderDetailModal] 주문 업데이트 성공', { orderId });
        showAlert('주문 정보가 성공적으로 업데이트되었습니다.', 'success');
        toggleOrderEditMode(false);
        
        // 모달 닫기
        hideModal();
        
        // 테이블 새로고침
        window.location.reload();
      } else {
        console.error('[OrderDetailModal] 주문 업데이트 실패', response);
        showAlert(response.message || '주문 수정 중 오류가 발생했습니다.', 'error');
      }
    } catch (error) {
      console.error('[OrderDetailModal] 주문 수정 중 예외 발생', error);
      showAlert('주문 수정 중 오류가 발생했습니다: ' + error.message, 'error');
    } finally {
      toggleLoading(false);
      
      // 편집 중인 필드 초기화
      editingFields.clear();
    }
  }
  
  /**
   * 폼 유효성 검사
   * @param {HTMLFormElement} form - 폼 요소
   * @returns {boolean} - 유효성 검사 결과
   */
  function validateForm(form) {
    const requiredElements = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredElements.forEach(element => {
      if (!element.value.trim()) {
        element.classList.add('invalid');
        isValid = false;
      } else {
        element.classList.remove('invalid');
      }
    });
    
    return isValid;
  }
  
  /**
   * 폼 데이터 수집
   * @param {HTMLFormElement} form - 폼 요소
   * @returns {Object} - 폼 데이터 객체
   */
  function getFormData(form) {
    const formData = {};
    const elements = form.elements;
    
    for (let i = 0; i < elements.length; i++) {
      const element = elements[i];
      
      if (element.name && element.name !== '') {
        formData[element.name] = element.value;
      }
    }
    
    return formData;
  }
  
  /**
   * API 호출 함수
   * @param {string} method - HTTP 메서드
   * @param {string} url - API URL
   * @param {Object} data - 요청 데이터
   * @returns {Promise<Object>} - 응답 데이터
   */
  async function callApi(method, url, data) {
    try {
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        }
      };
      
      if (data && (method === 'POST' || method === 'PUT')) {
        options.body = JSON.stringify(data);
      }
      
      const response = await fetch(url, options);
      
      if (!response.ok) {
        throw new Error(`HTTP 오류: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error(`[OrderDetailModal] API ${method} 오류:`, error);
      return {
        success: false,
        message: '서버 통신 중 오류가 발생했습니다.'
      };
    }
  }
  
  /**
   * 로딩 표시 토글
   * @param {boolean} isLoading - 로딩 중 여부
   */
  function toggleLoading(isLoading) {
    const loadingSpinner = document.querySelector('.global-loading');
    
    if (loadingSpinner) {
      loadingSpinner.style.display = isLoading ? 'flex' : 'none';
    } else if (isLoading) {
      // 글로벌 로딩 스피너가 없는 경우 생성
      const spinner = document.createElement('div');
      spinner.className = 'global-loading';
      spinner.innerHTML = `
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="spinner-text">처리 중...</div>
        </div>
      `;
      document.body.appendChild(spinner);
    }
  }
  
  /**
   * 알림 표시
   * @param {string} message - 메시지
   * @param {string} type - 알림 타입 (success, warning, error, info)
   */
  function showAlert(message, type = 'info') {
    if (window.Alerts && typeof window.Alerts[type] === 'function') {
      window.Alerts[type](message);
    } else {
      alert(message);
    }
  }
  
  /**
   * 다른 모달 표시
   * @param {string} modalId - 모달 ID
   */
  function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal && typeof window.showModal === 'function') {
      window.showModal(modal);
    } else if (modal) {
      modal.style.display = 'flex';
      document.body.classList.add('modal-open');
      
      setTimeout(() => modal.classList.add('show'), 10);
    }
  }
  
  /**
   * 현재 주문 ID 가져오기
   */
  function getCurrentOrderId() {
    return localStorage.getItem('currentOrderId');
  }
  
  // 문서 로드 완료 시 초기화
  document.addEventListener('DOMContentLoaded', init);
  
  // 공개 API - 즉시 전역 객체에 등록
  window.orderDetailModal = {
    showOrderDetail: showOrderDetail,
    hideModal: hideModal
  };
  
  // 디버깅을 위해 전역 객체 확인
  console.log('[OrderDetailModal] 전역 객체 등록 완료', window.orderDetailModal);
})();
</script>
