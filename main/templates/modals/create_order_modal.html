<!-- 주문 생성 모달 -->
<div class="modal" id="createOrderModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">신규 배송 등록</h2>
        <button type="button" class="close-btn" id="closeCreateModalBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="createOrderForm" class="order-form">
          <div class="form-row">
            <div class="form-group">
              <label for="createOrderNo">주문번호 *</label>
              <input type="text" id="createOrderNo" name="orderNo" required/>
            </div>
            <div class="form-group">
              <label for="createType">유형 *</label>
              <select id="createType" name="type" required>
                <option value="">선택하세요</option>
                <option value="DELIVERY">배송</option>
                <option value="RETURN">회수</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="createDepartment">부서 *</label>
              <select id="createDepartment" name="department" required>
                <option value="">선택하세요</option>
                <option value="CS">CS</option>
                <option value="HES">HES</option>
                <option value="LENOVO">LENOVO</option>
              </select>
            </div>
            <div class="form-group">
              <label for="createWarehouse">창고 *</label>
              <select id="createWarehouse" name="warehouse" required>
                <option value="">선택하세요</option>
                <option value="SEOUL">서울</option>
                <option value="BUSAN">부산</option>
                <option value="GWANGJU">광주</option>
                <option value="DAEJEON">대전</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="createSLA">SLA *</label>
              <input type="text" id="createSLA" name="sla" required />
            </div>
            <div class="form-group">
              <label for="createETA">ETA *</label>
              <input type="datetime-local" id="createETA" name="eta" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="createPostalCode">우편번호 *</label>
              <input
                type="text"
                id="createPostalCode"
                name="postalCode"
                required
                maxlength="5"
                pattern="[0-9]{5}"
                title="우편번호는 5자리 숫자여야 합니다"
              />
            </div>
            <div class="form-group full-width">
              <label for="createAddress">주소 *</label>
              <input type="text" id="createAddress" name="address" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="createCustomer">고객명 *</label>
              <input type="text" id="createCustomer" name="customer" required />
            </div>
            <div class="form-group">
              <label for="createContact">연락처 *</label>
              <input
                type="text"
                id="createContact"
                name="contact"
                required
                pattern="010-[0-9]{4}-[0-9]{4}"
              />
              <small class="form-hint">형식: 010-XXXX-XXXX</small>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group full-width">
              <label for="createRemark">비고 (메모)</label>
              <textarea id="createRemark" name="remark" rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn secondary-btn" id="cancelCreateBtn">취소</button>
        <button type="button" class="btn primary-btn" id="submitCreateBtn">등록</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  /**
   * 초기화 함수
   */
  function init() {
    console.log('[CreateOrderModal] 초기화 시작');
    
    // 신규 등록 버튼 이벤트
    const createOrderBtn = document.getElementById('createOrderBtn');
    if (createOrderBtn) {
      createOrderBtn.addEventListener('click', function() {
        showModal();
        setupDefaultValues();
      });
    }
    
    // 닫기/취소 버튼 이벤트
    const closeCreateModalBtn = document.getElementById('closeCreateModalBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    
    if (closeCreateModalBtn) {
      closeCreateModalBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    if (cancelCreateBtn) {
      cancelCreateBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    // 등록 버튼 이벤트
    const submitCreateBtn = document.getElementById('submitCreateBtn');
    if (submitCreateBtn) {
      submitCreateBtn.addEventListener('click', function() {
        submitCreateOrder();
      });
    }
    
    // 우편번호 입력 처리
    const postalCodeInput = document.getElementById('createPostalCode');
    if (postalCodeInput) {
      postalCodeInput.addEventListener('blur', function() {
        this.value = formatPostalCode(this.value);
      });
    }
    
    console.log('[CreateOrderModal] 초기화 완료');
  }
  
  /**
   * 기본값 설정
   */
  function setupDefaultValues() {
    // ETA 기본값 설정 (내일 12시)
    const createETAInput = document.getElementById('createETA');
    if (createETAInput && !createETAInput.value) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(12, 0, 0, 0);
      createETAInput.value = tomorrow.toISOString().slice(0, 16);
    }
    
    // 폼 리셋
    const form = document.getElementById('createOrderForm');
    if (form) {
      form.reset();
    }
  }
  
  /**
   * 모달 표시
   */
  function showModal() {
    const modal = document.getElementById('createOrderModal');
    if (!modal) return;
    
    // 모달 표시
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // 애니메이션 효과
    setTimeout(function() {
      modal.classList.add('show');
    }, 10);
  }
  
  /**
   * 모달 숨김
   */
  function hideModal() {
    const modal = document.getElementById('createOrderModal');
    if (!modal) return;
    
    // 애니메이션 효과
    modal.classList.remove('show');
    
    // 약간의 지연 후 완전히 숨김
    setTimeout(function() {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }, 300);
  }
  
  /**
   * 주문 생성 제출
   */
  async function submitCreateOrder() {
    const form = document.getElementById('createOrderForm');
    if (!form) return;
    
    // 폼 유효성 검사
    if (!validateForm(form)) {
      showAlert('필수 항목을 모두 입력해주세요.', 'warning');
      return;
    }
    
    // 폼 데이터 수집
    const formData = getFormData(form);
    
    // 우편번호 형식 처리
    if (formData.postalCode) {
      formData.postalCode = formatPostalCode(formData.postalCode);
    }
    
    try {
      toggleLoading(true);
      
      // API 호출
      const response = await callApi('POST', '/dashboard/orders', formData);
      
      if (response.success) {
        showAlert('주문이 성공적으로 생성되었습니다.', 'success');
        
        // 모달 닫기
        hideModal();
        
        // 테이블 새로고침
        window.location.reload();
      } else {
        showAlert(response.message || '주문 생성 중 오류가 발생했습니다.', 'error');
      }
    } catch (error) {
      console.error('[CreateOrderModal] 주문 생성 중 오류:', error);
      showAlert('주문 생성 중 오류가 발생했습니다.', 'error');
    } finally {
      toggleLoading(false);
    }
  }
  
  /**
   * 폼 유효성 검사
   * @param {HTMLFormElement} form - 폼 요소
   * @returns {boolean} - 유효성 검사 결과
   */
  function validateForm(form) {
    const requiredElements = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredElements.forEach(element => {
      if (!element.value.trim()) {
        element.classList.add('invalid');
        isValid = false;
      } else {
        element.classList.remove('invalid');
      }
    });
    
    return isValid;
  }
  
  /**
   * 폼 데이터 수집
   * @param {HTMLFormElement} form - 폼 요소
   * @returns {Object} - 폼 데이터 객체
   */
  function getFormData(form) {
    const formData = {};
    const elements = form.elements;
    
    for (let i = 0; i < elements.length; i++) {
      const element = elements[i];
      
      if (element.name && element.name !== '') {
        formData[element.name] = element.value;
      }
    }
    
    return formData;
  }
  
  /**
   * 우편번호 형식화
   * @param {string} postalCode - 우편번호
   * @returns {string} - 형식화된 우편번호
   */
  function formatPostalCode(postalCode) {
    if (!postalCode) return '';
    
    try {
      // 숫자만 추출
      const digits = postalCode.toString().replace(/\D/g, '');
      
      // 4자리인 경우 앞에 0 추가
      if (digits.length === 4) {
        return '0' + digits;
      }
      
      return digits;
    } catch (error) {
      console.error('[CreateOrderModal] 우편번호 포맷팅 오류:', error);
      return postalCode; // 오류 시 원본 반환
    }
  }
  
  /**
   * API 호출 함수
   * @param {string} method - HTTP 메서드
   * @param {string} url - API URL
   * @param {Object} data - 요청 데이터
   * @returns {Promise<Object>} - 응답 데이터
   */
  async function callApi(method, url, data) {
    try {
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        }
      };
      
      if (data && (method === 'POST' || method === 'PUT')) {
        options.body = JSON.stringify(data);
      }
      
      const response = await fetch(url, options);
      
      if (!response.ok) {
        throw new Error(`HTTP 오류: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error(`[CreateOrderModal] API ${method} 오류:`, error);
      return {
        success: false,
        message: '서버 통신 중 오류가 발생했습니다.'
      };
    }
  }
  
  /**
   * 로딩 표시 토글
   * @param {boolean} isLoading - 로딩 중 여부
   */
  function toggleLoading(isLoading) {
    const loadingSpinner = document.querySelector('.global-loading');
    
    if (loadingSpinner) {
      loadingSpinner.style.display = isLoading ? 'flex' : 'none';
    } else if (isLoading) {
      // 글로벌 로딩 스피너가 없는 경우 생성
      const spinner = document.createElement('div');
      spinner.className = 'global-loading';
      spinner.innerHTML = `
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="spinner-text">처리 중...</div>
        </div>
      `;
      document.body.appendChild(spinner);
    }
  }
  
  /**
   * 알림 표시
   * @param {string} message - 메시지
   * @param {string} type - 알림 타입 (success, warning, error, info)
   */
  function showAlert(message, type = 'info') {
    if (window.Alerts && typeof window.Alerts[type] === 'function') {
      window.Alerts[type](message);
    } else {
      alert(message);
    }
  }
  
  // 문서 로드 완료 시 초기화
  document.addEventListener('DOMContentLoaded', init);
  
  // 공개 API
  window.createOrderModal = {
    show: showModal,
    hide: hideModal
  };
})();
</script>
