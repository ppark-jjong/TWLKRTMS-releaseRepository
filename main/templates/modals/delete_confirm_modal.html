<!-- 삭제 확인 모달 -->
<div class="modal" id="deleteConfirmModal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">주문 삭제</h2>
        <button type="button" class="close-btn" id="closeDeleteModalBtn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>선택한 주문을 삭제하시겠습니까?</p>
        <p class="delete-warning">삭제된 주문은 복구할 수 없습니다.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn secondary-btn" id="cancelDeleteBtn">취소</button>
        <button type="button" class="btn delete-btn" id="confirmDeleteBtn">삭제</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  /**
   * 초기화 함수
   */
  function init() {
    console.log('[DeleteConfirmModal] 초기화 시작');
    
    // 닫기/취소 버튼 이벤트
    const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    
    if (closeDeleteModalBtn) {
      closeDeleteModalBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    if (cancelDeleteBtn) {
      cancelDeleteBtn.addEventListener('click', function() {
        hideModal();
      });
    }
    
    // 삭제 확인 버튼 이벤트
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener('click', function() {
        const orderId = getCurrentOrderId();
        if (orderId) {
          submitOrderDelete(orderId);
        } else {
          showAlert('삭제할 주문 정보가 없습니다.', 'error');
        }
      });
    }
    
    console.log('[DeleteConfirmModal] 초기화 완료');
  }
  
  /**
   * 모달 표시
   */
  function showModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if (!modal) return;
    
    // 권한 확인
    const userRole = document.body.dataset.userRole || 'USER';
    if (userRole !== 'ADMIN') {
      showAlert('삭제 권한이 없습니다.', 'error');
      return;
    }
    
    // 모달 표시
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // 애니메이션 효과
    setTimeout(function() {
      modal.classList.add('show');
    }, 10);
  }
  
  /**
   * 모달 숨김
   */
  function hideModal() {
    const modal = document.getElementById('deleteConfirmModal');
    if (!modal) return;
    
    // 애니메이션 효과
    modal.classList.remove('show');
    
    // 약간의 지연 후 완전히 숨김
    setTimeout(function() {
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }, 300);
  }
  
  /**
   * 주문 삭제 제출
   * @param {string} orderId - 주문 ID
   */
  async function submitOrderDelete(orderId) {
    // 권한 확인
    const userRole = document.body.dataset.userRole || 'USER';
    if (userRole !== 'ADMIN') {
      showAlert('주문 삭제 권한이 없습니다.', 'error');
      return;
    }
    
    if (!orderId) {
      showAlert('삭제할 주문 정보가 없습니다.', 'error');
      return;
    }
    
    try {
      toggleLoading(true);
      
      // API 호출
      const response = await callApi('POST', '/dashboard/delete', { ids: [orderId] });
      
      if (response.success) {
        showAlert('주문이 성공적으로 삭제되었습니다.', 'success');
        
        // 확인 모달 닫기
        hideModal();
        
        // 상세 모달 닫기
        hideOrderDetailModal();
        
        // 테이블 새로고침
        window.location.reload();
      } else {
        showAlert(response.message || '주문 삭제 중 오류가 발생했습니다.', 'error');
      }
    } catch (error) {
      console.error('[DeleteConfirmModal] 주문 삭제 중 오류:', error);
      showAlert('주문 삭제 중 오류가 발생했습니다.', 'error');
    } finally {
      toggleLoading(false);
    }
  }
  
  /**
   * 상세 모달 닫기
   */
  function hideOrderDetailModal() {
    const orderDetailModal = document.getElementById('orderDetailModal');
    if (orderDetailModal) {
      orderDetailModal.style.display = 'none';
      orderDetailModal.classList.remove('show');
    }
  }
  
  /**
   * API 호출 함수
   * @param {string} method - HTTP 메서드
   * @param {string} url - API URL
   * @param {Object} data - 요청 데이터
   * @returns {Promise<Object>} - 응답 데이터
   */
  async function callApi(method, url, data) {
    try {
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        }
      };
      
      if (data && (method === 'POST' || method === 'PUT')) {
        options.body = JSON.stringify(data);
      }
      
      const response = await fetch(url, options);
      
      if (!response.ok) {
        throw new Error(`HTTP 오류: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error(`[DeleteConfirmModal] API ${method} 오류:`, error);
      return {
        success: false,
        message: '서버 통신 중 오류가 발생했습니다.'
      };
    }
  }
  
  /**
   * 로딩 표시 토글
   * @param {boolean} isLoading - 로딩 중 여부
   */
  function toggleLoading(isLoading) {
    const loadingSpinner = document.querySelector('.global-loading');
    
    if (loadingSpinner) {
      loadingSpinner.style.display = isLoading ? 'flex' : 'none';
    } else if (isLoading) {
      // 글로벌 로딩 스피너가 없는 경우 생성
      const spinner = document.createElement('div');
      spinner.className = 'global-loading';
      spinner.innerHTML = `
        <div class="spinner-container">
          <div class="spinner"></div>
          <div class="spinner-text">처리 중...</div>
        </div>
      `;
      document.body.appendChild(spinner);
    }
  }
  
  /**
   * 알림 표시
   * @param {string} message - 메시지
   * @param {string} type - 알림 타입 (success, warning, error, info)
   */
  function showAlert(message, type = 'info') {
    if (window.Alerts && typeof window.Alerts[type] === 'function') {
      window.Alerts[type](message);
    } else {
      alert(message);
    }
  }
  
  /**
   * 현재 주문 ID 가져오기
   */
  function getCurrentOrderId() {
    return localStorage.getItem('currentOrderId');
  }
  
  // 문서 로드 완료 시 초기화
  document.addEventListener('DOMContentLoaded', init);
  
  // 공개 API
  window.deleteConfirmModal = {
    show: showModal,
    hide: hideModal
  };
})();
</script>
