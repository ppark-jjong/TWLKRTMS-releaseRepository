{% extends "base.html" %} {% block title %}{% if is_edit %}주문 수정{% else
%}신규 주문 등록{% endif %} - TeckwahKR TMS{% endblock %} {% block page_css %}
<link rel="stylesheet" href="{{ url_for('static', path='css/orders.css') }}" />
{% endblock %} {% block content %}

<div class="order-form-page">
  <div class="page-header">
    <h1 class="page-title">
      <i class="fa-solid {% if is_edit %}fa-edit{% else %}fa-plus{% endif %}"></i>
      <span>{% if is_edit %}주문 정보 수정{% else %}신규 배송 등록{% endif %}</span>
    </h1>
    <div class="header-actions">
      <a href="{% if is_edit %}/orders/{{ order.dashboard_id }}{% else %}/dashboard{% endif %}" class="btn secondary-btn">
        <i class="fa-solid fa-times"></i>
        취소
      </a>
      <button
        type="submit"
        form="orderForm"
        class="btn primary-btn"
        id="submitBtn"
      >
        <i class="fa-solid fa-check"></i>
        <span>{% if is_edit %}저장{% else %}등록하기{% endif %}</span>
      </button>
    </div>
  </div>

  {% if error_message %}
  <div class="alert alert-danger">
    <i class="fa-solid fa-circle-exclamation"></i>
    {{ error_message }}
  </div>
  {% endif %}
  
  {% if success_message %}
  <div class="alert alert-success">
    <i class="fa-solid fa-circle-check"></i>
    {{ success_message }}
  </div>
  {% endif %}

  <div class="main-card">
    <form id="orderForm" method="POST" class="order-form two-column-form" 
          action="{% if is_edit %}/api/orders/{{ order.dashboard_id }}{% else %}/api/orders{% endif %}">
      <div class="form-section">
        <h3 class="section-title">기본 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="order_no">주문번호 <span class="required">*</span></label>
            <input
              type="text"
              id="order_no"
              name="order_no"
              class="input-field"
              value="{{ order.order_no if is_edit else '' }}"
              required
              {% if is_edit %}readonly{% endif %}
            />
          </div>
          <div class="form-group">
            <label for="type">유형 <span class="required">*</span></label>
            <select id="type" name="type" class="select-field" required>
              <option value="DELIVERY" {% if is_edit and order.type == 'DELIVERY' %}selected{% endif %}>배송</option>
              <option value="RETURN" {% if is_edit and order.type == 'RETURN' %}selected{% endif %}>회수</option>
            </select>
          </div>
          <div class="form-group">
            <label for="department">부서 <span class="required">*</span></label>
            <select id="department" name="department" class="select-field" required>
              <option value="CS" {% if is_edit and order.department == 'CS' %}selected{% endif %}>CS</option>
              <option value="HES" {% if is_edit and order.department == 'HES' %}selected{% endif %}>HES</option>
              <option value="LENOVO" {% if is_edit and order.department == 'LENOVO' %}selected{% endif %}>LENOVO</option>
            </select>
          </div>
          <div class="form-group">
            <label for="warehouse">창고 <span class="required">*</span></label>
            <select id="warehouse" name="warehouse" class="select-field" required>
              <option value="SEOUL" {% if is_edit and order.warehouse == 'SEOUL' %}selected{% endif %}>서울</option>
              <option value="BUSAN" {% if is_edit and order.warehouse == 'BUSAN' %}selected{% endif %}>부산</option>
              <option value="GWANGJU" {% if is_edit and order.warehouse == 'GWANGJU' %}selected{% endif %}>광주</option>
              <option value="DAEJEON" {% if is_edit and order.warehouse == 'DAEJEON' %}selected{% endif %}>대전</option>
            </select>
          </div>
          <div class="form-group">
            <label for="sla">SLA <span class="required">*</span></label>
            <input
              type="text"
              id="sla"
              name="sla"
              class="input-field"
              value="{{ order.sla if is_edit else '' }}"
              required
            />
          </div>
          <div class="form-group">
            <label for="eta">ETA <span class="required">*</span></label>
            <div class="input-with-button">
              <input
                type="datetime-local"
                id="eta"
                name="eta"
                class="input-field"
                value="{{ order.eta if is_edit and order.eta else '' }}"
                required
              />
              <button type="button" id="etaNowBtn" class="inline-btn">지금</button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">배송 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="postal_code">우편번호 <span class="required">*</span></label>
            <input
              type="text"
              id="postal_code"
              name="postal_code"
              class="input-field"
              value="{{ order.postal_code if is_edit else '' }}"
              maxlength="5"
              placeholder="숫자 5자리"
              required
            />
            <small class="form-text text-muted">숫자 5자리로 입력해주세요</small>
          </div>
          <div class="form-group">
            <label for="customer">고객명 <span class="required">*</span></label>
            <input
              type="text"
              id="customer"
              name="customer"
              class="input-field"
              value="{{ order.customer if is_edit else '' }}"
              required
            />
          </div>
        </div>
        <div class="form-group form-group-full-width">
          <label for="address">주소 <span class="required">*</span></label>
          <input
            type="text"
            id="address"
            name="address"
            class="input-field"
            value="{{ order.address if is_edit else '' }}"
            required
          />
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="contact">연락처</label>
            <input
              type="text"
              id="contact"
              name="contact"
              class="input-field"
              value="{{ order.contact|default('', true) if is_edit else '' }}"
              placeholder="010-0000-0000"
            />
            <small class="form-text text-muted">하이픈(-)은 자동으로 입력됩니다</small>
          </div>
          <div class="form-group">
            <label for="status">상태 <span class="required">*</span></label>
            {% if is_edit %}
            <select
              id="status"
              name="status"
              class="select-field"
              required
            >
              <option value="WAITING" {% if order.status == 'WAITING' %}selected{% endif %}>대기</option>
              <option value="IN_PROGRESS" {% if order.status == 'IN_PROGRESS' %}selected{% endif %}>진행</option>
              <option value="COMPLETE" {% if order.status == 'COMPLETE' %}selected{% endif %}>완료</option>
              <option value="ISSUE" {% if order.status == 'ISSUE' %}selected{% endif %}>이슈</option>
              <option value="CANCEL" {% if order.status == 'CANCEL' %}selected{% endif %}>취소</option>
            </select>
            {% else %}
            <!-- 신규 주문 생성 시 상태는 항상 '대기'로 고정 -->
            <input type="text" class="input-field" value="대기" disabled />
            <input type="hidden" id="status" name="status" value="WAITING" />
            {% endif %}
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">기사 정보</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="driver_name">기사명</label>
            <input
              type="text"
              id="driver_name"
              name="driver_name"
              class="input-field"
              value="{{ order.driver_name|default('', true) if is_edit else '' }}"
            />
          </div>
          <div class="form-group">
            <label for="driver_contact">기사 연락처</label>
            <input
              type="text"
              id="driver_contact"
              name="driver_contact"
              class="input-field"
              value="{{ order.driver_contact|default('', true) if is_edit else '' }}"
              placeholder="010-0000-0000"
            />
            <small class="form-text text-muted">하이픈(-)은 자동으로 입력됩니다</small>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">추가 정보</h3>
        <div class="form-group form-group-full-width">
          <label for="remark">메모</label>
          <textarea
            id="remark"
            name="remark"
            class="text-area"
            rows="3"
          >{{ order.remark|default('', true) if is_edit else '' }}</textarea>
        </div>
      </div>

      <div id="update-info-section-placeholder"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script>
  // status_labels 정의 (전역 또는 필요한 스코프)
  const status_labels = {
      'WAITING': '대기',
      'IN_PROGRESS': '진행',
      'COMPLETE': '완료',
      'ISSUE': '이슈',
      'CANCEL': '취소'
  };
  
  document.addEventListener('DOMContentLoaded', function () {
    // 우편번호 자동 포맷팅 및 유효성 검사
    const postalCodeInput = document.getElementById('postal_code');
    if (postalCodeInput) {
      // 입력 제한: 숫자만 입력 가능, 최대 5자리
      postalCodeInput.addEventListener('input', function(e) {
        // 숫자만 허용
        this.value = this.value.replace(/[^\d]/g, '');
        
        // 5자 이상 입력 방지
        if (this.value.length > 5) {
          this.value = this.value.slice(0, 5);
        }
      });

      // 자동 포맷팅: 4자리만 입력한 경우 앞에 0 붙이기
      postalCodeInput.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value.length === 4 && /^\d{4}$/.test(value)) {
          this.value = '0' + value;
        }
      });
    }

    // 연락처 자동 하이픈 포맷팅
    const contactInput = document.getElementById('contact');
    if (contactInput) {
      contactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
      
      // 유효성 검사
      contactInput.addEventListener('blur', function() {
        if (this.value && this.value.length < 8) {
          Utils.alerts.showWarning('연락처 형식이 올바르지 않습니다. 정확한 번호를 입력해주세요.');
        }
      });
    }
    
    // 기사 연락처 자동 하이픈 포맷팅
    const driverContactInput = document.getElementById('driver_contact');
    if (driverContactInput) {
      driverContactInput.addEventListener('input', function() {
        // 숫자만 허용
        const numericValue = this.value.replace(/[^\d]/g, '');
        // 하이픈 포맷팅 적용
        this.value = Utils.formatPhoneNumber(numericValue);
      });
      
      // 유효성 검사
      driverContactInput.addEventListener('blur', function() {
        if (this.value && this.value.length < 8) {
          Utils.alerts.showWarning('기사 연락처 형식이 올바르지 않습니다. 정확한 번호를 입력해주세요.');
        }
      });
    }

    // ETA 날짜/시간 선택기 개선 (flatpickr)
    const etaInput = document.getElementById('eta');
    const etaNowBtn = document.getElementById('etaNowBtn');
    
    if (etaInput) {
      // ETA 기존 값이 있으면 파싱
      let defaultDate = null;
      const currentValue = etaInput.value;
      if (currentValue) {
        try {
          defaultDate = new Date(currentValue);
        } catch (e) {
          // ETA 날짜 파싱 오류 발생
        }
      }

      // flatpickr 초기화
      const etaPicker = flatpickr(etaInput, {
        locale: "ko",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minuteIncrement: 10,
        defaultDate: defaultDate,
        disableMobile: true,
        allowInput: true
      });

      // '지금' 버튼 이벤트 설정
      if (etaNowBtn) {
        etaNowBtn.addEventListener('click', function() {
          const now = new Date();
          etaPicker.setDate(now, true);
        });
      }
    }

    // --- 주문 상태 드롭다운 변경 시 유효성 검증 및 알림 (재추가/수정) ---
    const statusSelect = document.getElementById('status');
    const currentUserRole = "{{ current_user.user_role }}"; // Jinja 템플릿 변수 가져오기
    
    if (statusSelect) {
      const initialStatus = statusSelect.value;

      // 최종 상태 변경 규칙 (프론트엔드 유효성 검증용)
      const allowedTransitions = {
        'WAITING': ['WAITING', 'IN_PROGRESS', 'ISSUE', 'CANCEL'],
        'IN_PROGRESS': ['IN_PROGRESS', 'COMPLETE', 'ISSUE', 'CANCEL'],
        'COMPLETE': ['COMPLETE', 'ISSUE', 'CANCEL'],
        'ISSUE': ['ISSUE'], 
        'CANCEL': ['CANCEL'] 
      };
      // 관리자 역행 경로
      const adminReverseTransitions = {
         'IN_PROGRESS': ['WAITING'],
         'COMPLETE': ['IN_PROGRESS']
      };
      
      // 옵션 활성화/비활성화 로직 제거
      /*
      const options = statusSelect.options;
      let allowedNextStates = [];
      allowedNextStates.push(initialStatus);
      if (initialStatus !== 'ISSUE' && initialStatus !== 'CANCEL') {
           allowedNextStates.push(...(allowedTransitions[initialStatus] || []));
           if (currentUserRole === 'ADMIN') {
               allowedNextStates.push(...(adminReverseTransitions[initialStatus] || []));
           }
      }
      allowedNextStates = [...new Set(allowedNextStates)];
      for (let i = 0; i < options.length; i++) {
        const option = options[i];
        if (!allowedNextStates.includes(option.value)) {
          option.disabled = true;
        } else {
          option.disabled = false;
        }
      }
      */

      // 'change' 이벤트 리스너 추가 (알림 방식)
      statusSelect.addEventListener('change', function() {
        const currentStatus = initialStatus; // 변경 시점의 초기 상태 기준
        const newStatus = this.value;
        
        let isAllowed = false;
        let allowedNext = [];
        
        // 허용 경로 결정
        if (currentStatus !== 'ISSUE' && currentStatus !== 'CANCEL') {
            allowedNext.push(...(allowedTransitions[currentStatus] || []));
            if (currentUserRole === 'ADMIN') {
                allowedNext.push(...(adminReverseTransitions[currentStatus] || []));
            }
            allowedNext = [...new Set(allowedNext)]; // 중복 제거
        } else {
             allowedNext.push(currentStatus); // 최종 상태는 자기 자신만 허용
        }
        
        isAllowed = allowedNext.includes(newStatus);

        // 허용되지 않는 변경 시 알림 및 되돌리기
        if (!isAllowed) {
          this.value = currentStatus; // 이전 값으로 되돌리기
          
          // 알림 메시지 생성 (이전 로직 재활용 및 개선)
          let errorMessage = `'${status_labels[currentStatus] || currentStatus}' 상태에서는 '${status_labels[newStatus] || newStatus}' 상태로 변경할 수 없습니다.`;
          if (currentStatus === 'WAITING') {
              errorMessage = `'대기' 상태에서는 '진행', '이슈', '취소'만 가능합니다.`;
          } else if (currentStatus === 'IN_PROGRESS') {
              errorMessage = currentUserRole === 'ADMIN' ? `'진행' 상태에서는 '대기', '완료', '이슈', '취소'만 가능합니다.` : `'진행' 상태에서는 '완료', '이슈', '취소'만 가능합니다.`;
          } else if (currentStatus === 'COMPLETE') {
               errorMessage = currentUserRole === 'ADMIN' ? `'완료' 상태에서는 '진행', '이슈', '취소'만 가능합니다.` : `'완료' 상태에서는 '이슈' 또는 '취소'만 가능합니다.`;
          } else if (currentStatus === 'ISSUE') {
              errorMessage = `'이슈' 상태는 변경할 수 없습니다.`;
          } else if (currentStatus === 'CANCEL') {
              errorMessage = `'취소' 상태는 변경할 수 없습니다.`;
          }
          
          // 알림 표시
          if (typeof Utils !== 'undefined' && Utils.alerts && Utils.alerts.showWarning) {
              Utils.alerts.showWarning(errorMessage);
          } else {
              alert(errorMessage); // 폴백
          }
        }
      });
    }
    // --- 상태 드롭다운 제어 끝 ---

    // 페이지 나갈 때 락 해제
    /* {% if is_edit and order and order.dashboard_id %} */
    const dashboardId = "{{ order.dashboard_id }}";
    
    if (dashboardId) {
      // 페이지 이탈 시 락 해제 함수
      const releaseLock = async () => {
        try {
          // 락 해제 API 호출 (브라우저 캐시 방지용 랜덤 파라미터 추가)
          const response = await fetch(`/api/orders/${dashboardId}/release-lock?_=${Date.now()}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          await response.text(); // 락 해제 요청 완료
        } catch (error) {
          // 락 해제 중 오류 발생
        }
      };
      
      // 페이지 이탈 이벤트에 락 해제 연결
      window.addEventListener('beforeunload', releaseLock);
      
      // 취소 버튼 클릭 시에도 락 해제
      const cancelBtn = document.querySelector('.secondary-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
          // 기본 이벤트 방지 (href 이동 전에 락 해제 실행)
          e.preventDefault();
          
          // 락 해제 후 페이지 이동
          releaseLock().then(() => {
            window.location.href = this.getAttribute('href');
          });
        });
      }
    }
    /* {% endif %} */

    // 폼 제출 처리
    const form = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (form) {
      form.addEventListener('submit', function (e) {
        let hasError = false;
        
        // 우편번호 유효성 검사
        if (postalCodeInput && postalCodeInput.value.length !== 5) {
          e.preventDefault();
          Utils.alerts.showWarning('우편번호는 5자리 숫자로 입력해주세요.');
          postalCodeInput.focus();
          hasError = true;
        }
        
        // 연락처 유효성 검사 (입력된 경우)
        if (contactInput && contactInput.value && contactInput.value.replace(/[^0-9]/g, '').length < 8) {
          e.preventDefault();
          Utils.alerts.showWarning('올바른 연락처 형식으로 입력해주세요.');
          contactInput.focus();
          hasError = true;
        }
        
        // 기사 연락처 유효성 검사 (입력된 경우)
        if (driverContactInput && driverContactInput.value && driverContactInput.value.replace(/[^0-9]/g, '').length < 8) {
          e.preventDefault();
          Utils.alerts.showWarning('올바른 기사 연락처 형식으로 입력해주세요.');
          driverContactInput.focus();
          hasError = true;
        }
      
        // 오류가 없으면 로딩 상태 표시
        if (!hasError && submitBtn) {
          submitBtn.disabled = true;
          const isEdit = "{{ is_edit }}" === "True";
          submitBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${
            isEdit ? '저장 중...' : '등록 중...'
          }`;
        }
      });
    }
  });
</script>
{% endblock %}